<style lang="less">
@font-face {
  font-family: 'iconfont';
  src: url(data:font/truetype;charset=utf-8;base64,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YXJpY29uZm9udGljb25mb250VmVyc2lvbiAxLjBpY29uZm9udEdlbmVyYXRlZCBieSBzdmcydHRmIGZyb20gRm9udGVsbG8gcHJvamVjdC5odHRwOi8vZm9udGVsbG8uY29tAAoAQwByAGUAYQB0AGUAZAAgAGIAeQAgAGkAYwBvAG4AZgBvAG4AdAAKAGkAYwBvAG4AZgBvAG4AdABSAGUAZwB1AGwAYQByAGkAYwBvAG4AZgBvAG4AdABpAGMAbwBuAGYAbwBuAHQAVgBlAHIAcwBpAG8AbgAgADEALgAwAGkAYwBvAG4AZgBvAG4AdABHAGUAbgBlAHIAYQB0AGUAZAAgAGIAeQAgAHMAdgBnADIAdAB0AGYAIABmAHIAbwBtACAARgBvAG4AdABlAGwAbABvACAAcAByAG8AagBlAGMAdAAuAGgAdAB0AHAAOgAvAC8AZgBvAG4AdABlAGwAbABvAC4AYwBvAG0AAAAAAgAAAAAAAAAKAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALAQIBAwEEAQUBBgEHAQgBCQEKAQsBDAABeA9pb3NjbG9zZW91dGxpbmUUYWJjc291c3VvY2l4aWFuZ3FpbmcEZHJhZwV0aHVtYgdkZW5namkxBHZpZXcFc291bmQHY29tbWVudAZzb3VuZDEAAAA=) format('truetype');
  font-weight: normal;
  font-style: normal;
}
.information{
  &.information-show{
	  display: block;
  }
  .information-content{
    height: 200rpx;
    width: initial;
    .scroll-container{
      padding: 20px;
    }
  }
  display: none;
  position: fixed;
  z-index: 2;
  bottom: 0;
  width: 100%;
	margin: 0 auto;
  height: 1000rpx;
	opacity: 1;
	overflow: hidden;
	background-color: #fff;
	font-size: 14px;
	line-height: 18px;
  word-break: break-all;
  will-change: transform;
  /* transform: translateX(-50%) translateY(-50%); */
  transform: translate3d(0, 550rpx, 0);
  animation: slideInUpHalf .3s ;
  transition: transform .3s;
  &.isDetail{
  transform: initial;
  .information-content{
    height: 750rpx;
  }
  }
  .word{
    font-size: 16pt;
    font-weight: 400;
    color:rgb(32, 158, 133);
  }
  .pron{
    color:gray;
    margin-left: 10rpx;
  }
  .audio{
    font-family: 'iconfont';
    float:right;
    margin-top:22rpx;
    color:rgb(32, 158, 133);
    &:before{
      content: '\e605';
      margin-right: 10rpx;
      font-size: 16pt;
    }
  }
  .definition{
    margin-top: 16rpx;
    .definition-item{
      display: block;
    }
  }
  .detail-btn{
    color:#28bea0;
    border: 1px solid #28bea0;
    background-color: #fff;
    width:300rpx;
    border-radius:5px;
    padding-top:2px;
    font-size:14px;
    overflow:hidden;
    height:40px;
    position:absolute;
    left:50%;
    top:300rpx;
    transform:translateX(-50%);
    &.close{
      top:850rpx;
    }
  }
  .examples{
    color: gray;
    margin: 40rpx 0 20rpx;
  }
  .example-item{
    margin-bottom: 30rpx;
    word-break: keep-all;
    .current-word{
      color: rgb(32, 158, 133);
    }
    .example-translation{
      margin-top: 5rpx;
      word-break:break-all;
    }
  }
}
.slidedown-half{
  animation: slideOutDownHalf .3s;
}
.sliderdown{
  animation: slideOutDown .3s;
}
.slidebar{
  width: 100%;
  background-color: #eee;
  height: 70rpx;
  color:#bdbdbd;
  text-align: center;
  line-height: 70rpx;
  font-family: 'iconfont';
  &:before{
      content: '\e6e0';
      margin-right: 10rpx;
      font-size: 16pt;
    }
}
@keyframes slideInUpHalf {
  from {
    transform: translate3d(0, 100%, 0);
    visibility: visible;
  }

  to {
    transform: translate3d(0, 550rpx, 0);
  }
}
@keyframes slideOutDownHalf {
  from {
    transform: translate3d(0, 550rpx, 0);
  }

  to {
    visibility: hidden;
    transform: translate3d(0, 100%, 0);
  }
}
@keyframes slideInUp {
  from {
    transform: translate3d(0, 100%, 0);
    visibility: visible;
  }

  to {
    transform: translate3d(0, 0, 0);
  }
}
@keyframes slideOutDown {
  from {
    transform: translate3d(0, 0, 0);
  }

  to {
    visibility: hidden;
    transform: translate3d(0, 100%, 0);
  }
}
</style>

<template>
		<view class="information" style="{{cssText}}" @touchmove.stop="stopPropagation" @tap.stop="stopPropagation"  :class="{information-show:!!visible,slidedown-half:isSlidingDown && !isDetail,sliderdown:isSlidingDown && isDetail,isDetail:isDetail}">
      <view class="slidebar" @touchmove="touchmove" @touchstart.stop="touchstart" @touchend="touchend"></view>
      <scroll-view scroll-y class="information-content">
        <view class="scroll-container">
          <text class="word">{{word}}</text>
          <text class="pron">{{pron}}</text>
          <audio class="audio" id="audio" src="{{audio}}" @tap="play"/>
          <view class="definition">
            <repeat for="{{definition}}">
              <text class="definition-item">{{item}}</text>
            </repeat>
          </view>

          <view wx:if="{{isDetail}}">
            <view class="examples">例句</view>
            <block wx:for="{{examples}}" wx:key="index">
              <view class="example-item">
                <text>{{item.first}}</text>
                <text class="current-word">{{item.word}}</text>
                <text>{{item.last}}</text>
                <view class="example-translation">{{item.translation}}</view>
              </view>
            </block>
          </view>
        </view>
      </scroll-view>
      <button class="detail-btn" @tap="viewMore" wx:if="{{!isDetail}}">查看例句</button>
      <button class="detail-btn close" @tap="close" wx:else>关闭</button>
    </view>
</template>

<script>
import wepy from 'wepy'

export default class TipBox extends wepy.component {
  data = {
    visible: false,
    position: '',
    margin: '',
    word: '',
    audio: '',
    pron: '',
    definition: '',
    isSlidingDown: false,
    isDetail: false,
    examples: [{translation: '暂无例句'}],
    wordId: 0
  };

  computed = {
    cssText() {
      let styles = {}
      if (this.position === 'top') {
        styles.position = this.position
        styles.top = this.margin || ''
      } else if (this.position === 'bottom') {
        styles.position = this.position
        styles.top = 'initial'
        styles.bottom = this.margin || ''
      }
      let css = Object.keys(styles)
      .map(key => (key + ':' + styles[key]))
      .join(';')
      return css
    }
  };
  methods={
    stopPropagation(e) {
    },
    play() {
      this.audioCtx.play()
    },
    touchmove(e) {
      if (this.isTouching) return
      let currentY = e.touches[0].pageY
      if (currentY === this.lastY) return
      let isSlideDown = currentY > this.lastY
      this.isTouching = true // 避免误触
      this.handleSlide(isSlideDown)
    },
    touchstart(e) {
      this.lastY = e.touches[0].pageY
    },
    touchend(e) {
      this.isTouching = false
    },
    viewMore() {
      this.getDetails()
    },
    close() {
      this.hide()
    }
  }
  show({word, options}) {
    if (!word) {
      return
    }
    this.visible = true
    this.word = word
    // 清空当前结果，避免在网络慢的情况下点击了下一个词 翻译框内容还停留在上一个词
    this.pron = ''
    this.definition = ''
    this.audio = ''
    this.$apply()
    wx.request({
      url: `https://api.shanbay.com/bdc/search/?word=${word}`,
      success: (res) => {
        if (res.data.msg === 'SUCCESS') {
          var {audio, pron, definition, id, content} = res.data.data
          this.word = content // 用返回的词展示，例如查询的单词是“Daily”,返回的是“daily”，以返回的结果为准
          this.audio = audio
          this.pron = pron ? `/${pron}/` : ''
          this.definition = definition.split(/\r\n|\n|\r/)
          this.audioCtx.setSrc(audio)
          this.wordId = id
        } else {
          this.pron = ''
          this.audioCtx.setSrc('')
          this.definition = [].concat(res.data.msg)
        }
        this.$apply()
      }
    })
  }
  hide() {
    this.isSlidingDown = true
    this.$apply()
    setTimeout(() => {
      this.visible = false
      this.word = ''
      this.audio = ''
      this.pron = ''
      this.definition = ''
      this.position = ''
      this.margin = ''
      this.isSlidingDown = false
      this.isDetail = false
      this.examples = [{translation: '暂无例句'}]
      this.wordId = 0
      this.$apply()
    }, 300)
  }
  getDetails() {
    this.isDetail = true
    wx.request({
      url: `https://api.shanbay.com/bdc/example/?vocabulary_id=${this.wordId}&type=sys`,
      success: (res) => {
        if (res.data.msg === 'SUCCESS' && res.data.data.length) {
          this.examples = res.data.data.map(item => ({
            first: item.first,
            last: item.last,
            word: item.word,
            translation: item.translation
          }))
          this.$apply()
        }
      }
    })
  }
  handleSlide(isSlideDown) {
    if (isSlideDown) {
      if (this.isSlidingDown === false) {
        this.hide()
      }
    } else {
      this.getDetails()
    }
  }
  onLoad() {
    this.audioCtx = wx.createAudioContext('audio')
    // wx.request({
    //   url: 'https://www.shanbay.com/api/v2/news/notes/?para_id=A152718P134718&ipp=3&page=1',
    //   success: (res) => {
    //     // debugger
    //   }
    // })
  }
}
</script>
